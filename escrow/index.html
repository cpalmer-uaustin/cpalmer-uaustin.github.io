<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Escrow NOW!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="./escrowABI.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.5.0/ethers.umd.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Silkscreen&display=swap');
      .funky-font {
        font-family: 'Silkscreen', monospace;
      }
    </style>
  </head>
  <body class="bg-black text-gray-200 min-h-screen font-sans">
    <!-- Landing Page -->
    <div id="landing" class="flex flex-col items-center justify-center h-screen text-center">
      <h1 class="text-6xl text-green-400 funky-font cursor-pointer" onclick="startApp()">
        Escrow NOW!
      </h1>
      <p class="text-gray-400 mt-4 text-xl">Click to begin</p>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden max-w-3xl mx-auto p-6 space-y-10">
      <header class="text-center">
        <h1 class="text-4xl font-bold text-green-400">
          Escrow <span class="funky-font text-white">NOW!</span>
        </h1>
        <p class="text-gray-400">Secure and simple blockchain-based escrow</p>
        <hr class="my-4 border-gray-700" />
      </header>

      <section id="walletInfo" class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-white">Wallet Connection</h2>
        <p id="walletStatus" class="mt-2 text-red-400">Checking for a wallet connection...</p>
        <button
          onclick="checkWallet()"
          id="walletButton"
          class="mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded"
        >
          Connect Wallet
        </button>
      </section>

      <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-medium text-white">Status: <span id="responseMessage" class="text-green-400"></span></h3>
      </section>

      <section id="sectionOpen" class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-white mb-2">Open Escrow</h2>
        <p class="mb-4 text-gray-400">
          Before you open an escrow account, you must approve the funds transfer from your wallet.
        </p>

        <label for="amount" class="block font-medium text-white">Amount</label>
        <input type="number" id="amount" name="amount" min="1" class="mt-1 mb-4 w-full p-2 bg-gray-700 text-white rounded" />
        <button
          id="approveButton"
          onclick="approveButton()"
          class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded mb-4"
        >
          Approve Token Transfer
        </button>

        <label for="sellerAddress" class="block font-medium text-white">Seller Address</label>
        <input type="text" id="sellerAddress" name="sellerAddress" class="mt-1 mb-4 w-full p-2 bg-gray-700 text-white rounded" />

        <label for="mediatorAddress" class="block font-medium text-white">Mediator Address</label>
        <input type="text" id="mediatorAddress" name="mediatorAddress" class="mt-1 mb-4 w-full p-2 bg-gray-700 text-white rounded" />

        <button
          id="openButton"
          onclick="openEscrow()"
          disabled
          class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded"
        >
          Open Escrow
        </button>
      </section>

      <section id="sectionClose" class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-white mb-2">Close Escrow</h2>

        <label for="closeOption" class="block font-medium text-white">Close Escrow Option</label>
        <select
          id="closeOption"
          name="closeOption"
          required
          class="mt-1 mb-4 w-full p-2 bg-gray-700 text-white rounded"
        >
          <option value="paySeller">Pay Seller</option>
          <option value="returnFunds">Return Funds</option>
        </select>

        <button
          id="closeButton"
          onclick="closeEscrow()"
          class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded"
        >
          Close Escrow
        </button>
      </section>
    </div>

    <script>
      let myWallet = null;
      let contractInstance;
      const contractAddress = "YOUR_CONTRACT_ADDRESS_HERE"; // Replace with your contract address

      async function contractConnect() {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        contractInstance = new ethers.Contract(contractAddress, escrowABI, signer);
      }

      async function approveButton() {
        const amount = document.getElementById("amount").value;
        if (!amount || isNaN(amount)) {
          alert("Enter a valid amount");
          return;
        }
        try {
          const tx = await contractInstance.approveTokenTransfer(ethers.utils.parseEther(amount));
          await tx.wait();
          document.getElementById("responseMessage").innerText = "Token transfer approved.";
          document.getElementById("openButton").disabled = false;
        } catch (err) {
          console.error("Approval failed:", err);
          document.getElementById("responseMessage").innerText = `Approval failed: ${err.message}`;
        }
      }

      async function openEscrow() {
        const seller = document.getElementById("sellerAddress").value;
        const mediator = document.getElementById("mediatorAddress").value;
        const amount = document.getElementById("amount").value;

        if (!seller || !mediator || !amount) {
          alert("Fill in all fields.");
          return;
        }

        try {
          const tx = await contractInstance.openEscrow(seller, mediator, ethers.utils.parseEther(amount));
          await tx.wait();
          document.getElementById("responseMessage").innerText = "Escrow opened successfully.";
        } catch (err) {
          console.error("Open escrow failed:", err);
          document.getElementById("responseMessage").innerText = `Open escrow failed: ${err.message}`;
        }
      }

      async function closeEscrow() {
        const option = document.getElementById("closeOption").value;
        try {
          let tx;
          if (option === "paySeller") {
            tx = await contractInstance.paySeller();
          } else {
            tx = await contractInstance.returnFunds();
          }
          await tx.wait();
          document.getElementById("responseMessage").innerText = "Escrow closed successfully.";
        } catch (err) {
          console.error("Close escrow failed:", err);
          document.getElementById("responseMessage").innerText = `Close escrow failed: ${err.message}`;
        }
      }

      window.addEventListener('load', async () => {
        if (window.ethereum) {
          const accounts = await ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            myWallet = accounts[0];
            await contractConnect();
          }
        }
      });

      function startApp() {
        document.getElementById('landing').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        checkWallet();
      }

      async function checkWallet() {
        try {
          if (!window.ethereum) {
            document.getElementById('walletStatus').innerText = 'No crypto wallet found';
            return;
          }

          let accounts = await ethereum.request({ method: 'eth_accounts' });

          if (accounts.length === 0) {
            accounts = await ethereum.request({ method: 'eth_requestAccounts' });
          }

          myWallet = accounts[0];

          if (myWallet) {
            document.getElementById('walletStatus').innerHTML = "&#x2713; Your crypto wallet is connected.";
            document.getElementById('walletStatus').classList.remove('text-red-400');
            document.getElementById('walletStatus').classList.add('text-green-400');
            document.getElementById('walletButton').hidden = true;
            await contractConnect();
          } else {
            document.getElementById('walletStatus').innerText = "Click here to connect a crypto wallet:";
            document.getElementById('walletButton').hidden = false;
          }
        } catch (err) {
          console.error("Wallet connection error:", err);
          document.getElementById('walletStatus').innerText = `Error: ${err.message}`;
        }
      }
    </script>
  </body>
</html>
