<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escrow DApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script type="text/javascript" src="./escrowABI.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.5.0/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col items-center py-10 px-4">

  <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-4xl space-y-8">
    <h1 class="text-3xl font-bold text-indigo-600 text-center">üõ°Ô∏è Escrow DApp</h1>

    <!-- Wallet Section -->
    <section class="text-center">
      <p class="text-gray-700 font-semibold">Wallet Connection:</p>
      <p id="walletStatus" class="text-red-600">Checking for a wallet connection...</p>
      <button onclick="checkWallet()" id="walletButton" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Connect Wallet</button>
    </section>

    <p class="text-center text-blue-600 font-medium">Status: <span id="responseMessage"></span></p>

    <!-- Open Escrow Section -->
    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <h2 class="text-xl font-bold mb-2">Open Escrow</h2>
        <label class="block mb-1">Amount</label>
        <input type="number" id="amount" min="1" class="w-full p-2 border rounded mb-3">

        <button id="approveButton" onclick="approveButton()" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600 mb-4">Approve Token Transfer</button>

        <label class="block mb-1">Seller Address</label>
        <input type="text" id="sellerAddress" class="w-full p-2 border rounded mb-3">

        <label class="block mb-1">Mediator Address</label>
        <input type="text" id="mediatorAddress" class="w-full p-2 border rounded mb-4">

        <button id="openButton" onclick="openEscrow()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700" disabled>Open Escrow</button>
      </div>

      <!-- Close Escrow Section -->
      <div>
        <h2 class="text-xl font-bold mb-2">Close Escrow</h2>
        <label class="block mb-1">Close Option</label>
        <select id="closeOption" class="w-full p-2 border rounded mb-4">
          <option value="paySeller">Pay Seller</option>
          <option value="returnFunds">Return Funds</option>
        </select>

        <button id="closeButton" onclick="closeEscrow()" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700">Close Escrow</button>
      </div>
    </div>
  </div>

  <script>
    var myWallet, myContract, provider, signer;

    async function checkWallet() {
      let accounts = await ethereum.request({ method: 'eth_accounts' });
      myWallet = accounts[0];
      if (!myWallet) {
        await ethereum.request({ method: 'eth_requestAccounts' });
        accounts = await ethereum.request({ method: 'eth_accounts' });
        myWallet = accounts[0];
      }
      if (!myWallet) {
        document.getElementById('walletStatus').innerHTML = "Click here to connect a crypto wallet";
        document.getElementById('walletButton').hidden = false;
      } else {
        document.getElementById('walletStatus').innerHTML = "&#x2713; Wallet connected";
        document.getElementById('walletStatus').classList.replace('text-red-600', 'text-blue-600');
        document.getElementById('walletButton').hidden = true;
      }
      contractConnect();
    }

    async function contractConnect() {
      await ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      myContract = new ethers.Contract(escrowContractAddress, escrowABI, provider);
      signer = provider.getSigner();

      const buyer = await myContract.buyerAddress();
      if (buyer === "0x0000000000000000000000000000000000000000") {
        document.getElementById('responseMessage').innerText = "No funds in escrow.";
        document.getElementById('openButton').disabled = true;
        document.getElementById('closeButton').disabled = true;
        document.getElementById('sellerAddress').disabled = true;
        document.getElementById('mediatorAddress').disabled = true;
      }
    }

    async function approveButton() {
      let getAmt = document.getElementById('amount').value;
      document.getElementById('amount').disabled = true;
      document.getElementById('responseMessage').innerText = "Approval in progress...";
      document.getElementById('responseMessage').classList.replace('text-blue-600', 'text-red-600');

      const approveAmt = BigInt(getAmt * 10 ** 18);
      const tokenContract = new ethers.Contract(escrowTokenAddress, escrowTokenABI, signer);

      try {
        const tx = await tokenContract.approve(escrowContractAddress, approveAmt);
        await tx.wait();
        document.getElementById('responseMessage').innerText = "Funds transfer approved.";
        document.getElementById('responseMessage').classList.replace('text-red-600', 'text-blue-600');
        document.getElementById('sellerAddress').disabled = false;
        document.getElementById('mediatorAddress').disabled = false;
        document.getElementById('openButton').disabled = false;
        document.getElementById('approveButton').disabled = true;
      } catch (err) {
        console.error("Approve error:", err);
        document.getElementById('responseMessage').innerText = `Error: ${err.message}`;
      }
    }

    async function openEscrow() {
      document.getElementById('responseMessage').innerText = "Open account request sent.";
      document.getElementById('responseMessage').classList.replace('text-blue-600', 'text-red-600');

      const amount = document.getElementById('amount').value;
      const sellerAddress = document.getElementById('sellerAddress').value;
      const mediatorAddress = document.getElementById('mediatorAddress').value;

      if (amount <= 0 || !sellerAddress || !mediatorAddress) {
        alert("Please enter valid details.");
        return;
      }

      const wholeNumAmount = BigInt(amount * 10 ** 18);
      const contractWithSigner = myContract.connect(signer);

      try {
        const tx = await contractWithSigner.openEscrow(wholeNumAmount, sellerAddress, mediatorAddress);
        await tx.wait();
        document.getElementById('responseMessage').innerText = "Escrow account opened.";
        document.getElementById('responseMessage').classList.replace('text-red-600', 'text-blue-600');
        document.getElementById('closeButton').disabled = false;
        document.getElementById('sellerAddress').disabled = true;
        document.getElementById('mediatorAddress').disabled = true;
        document.getElementById('openButton').disabled = true;
        document.getElementById('approveButton').disabled = true;
      } catch (error) {
        console.error("Open Escrow error:", error);
        document.getElementById('responseMessage').innerText = `Error: ${error.message}`;
      }
    }

    async function closeEscrow() {
      document.getElementById('responseMessage').innerText = "Close account request sent.";
      document.getElementById('responseMessage').classList.replace('text-blue-600', 'text-red-600');
      document.getElementById('closeButton').disabled = true;

      const closeOption = document.getElementById('closeOption').value;
      const closeBool = closeOption === "paySeller" ? 1 : 0;

      try {
        const contractWithSigner = myContract.connect(signer);
        const tx = await contractWithSigner.closeEscrow(closeBool);
        await tx.wait();
        document.getElementById('responseMessage').innerText = "Escrow account closed.";
        document.getElementById('responseMessage').classList.replace('text-red-600', 'text-blue-600');
      } catch (error) {
        console.error("Close Escrow error:", error);
        document.getElementById('responseMessage').innerText = `Error: ${error.message}`;
      }
    }
  </script>
</body>
</html>
