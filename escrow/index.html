<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Escrow Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="./escrowABI.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.5.0/ethers.umd.min.js"></script>
  </head>
  <body class="bg-black text-gray-200 min-h-screen font-sans p-6" onload="checkWallet()">
    <div class="max-w-3xl mx-auto space-y-10">
      <header class="text-center">
        <h1 class="text-4xl font-bold text-green-400">My Escrow Page</h1>
        <p class="text-gray-400">Secure and simple blockchain-based escrow</p>
        <hr class="my-4 border-gray-700" />
      </header>

      <section id="walletInfo" class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-green-300">Wallet Connection</h2>
        <p id="walletStatus" class="mt-2 text-red-400">Checking for a wallet connection...</p>
        <button
          onclick="checkWallet()"
          id="walletButton"
          class="mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded"
        >
          Connect Wallet
        </button>
      </section>

      <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-medium">Status: <span id="responseMessage" class="text-green-400"></span></h3>
      </section>

      <section id="sectionOpen" class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-green-300 mb-2">Open Escrow</h2>
        <p class="mb-4 text-gray-400">
          Before you open an escrow account, you must approve the funds transfer from your wallet.
        </p>

        <label for="amount" class="block font-medium">Amount</label>
        <input type="number" id="amount" name="amount" min="1" class="mt-1 mb-4 w-full p-2 bg-gray-700 text-white rounded" />
        <button
          id="approveButton"
          onclick="approveButton()"
          class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded mb-4"
        >
          Approve Token Transfer
        </button>

        <label for="sellerAddress" class="block font-medium">Seller Address</label>
        <input type="text" id="sellerAddress" name="sellerAddress" class="mt-1 mb-4 w-full p-2 bg-gray-700 text-white rounded" />

        <label for="mediatorAddress" class="block font-medium">Mediator Address</label>
        <input type="text" id="mediatorAddress" name="mediatorAddress" class="mt-1 mb-4 w-full p-2 bg-gray-700 text-white rounded" />

        <button
          id="openButton"
          onclick="openEscrow()"
          disabled
          class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded"
        >
          Open Escrow
        </button>
      </section>

      <section id="sectionClose" class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-green-300 mb-2">Close Escrow</h2>

        <label for="closeOption" class="block font-medium">Close Escrow Option</label>
        <select
          id="closeOption"
          name="closeOption"
          required
          class="mt-1 mb-4 w-full p-2 bg-gray-700 text-white rounded"
        >
          <option value="paySeller">Pay Seller</option>
          <option value="returnFunds">Return Funds</option>
        </select>

        <button
          id="closeButton"
          onclick="closeEscrow()"
          class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded"
        >
          Close Escrow
        </button>
      </section>
    </div>

    <script>
      var myWallet;
      var myContract;
      var provider;
      var signer;

      async function checkWallet() {
        var accountList = await ethereum.request({ method: 'eth_accounts' });
        myWallet = accountList[0];

        if (!myWallet) {
          await window.ethereum.request({
            method: 'eth_requestAccounts',
            params: [{ eth_accounts: {} }]
          });
          accountList = await ethereum.request({ method: 'eth_accounts' });
          myWallet = accountList[0];
        }

        if (!myWallet) {
          document.getElementById('walletStatus').innerHTML = 'Click here to connect a crypto wallet:';
          document.getElementById('walletButton').hidden = false;
        } else {
          document.getElementById('walletStatus').innerHTML = '&#x2713; Your crypto wallet is connected.';
          document.getElementById('walletStatus').classList.remove('text-red-400');
          document.getElementById('walletStatus').classList.add('text-green-400');
          document.getElementById('walletButton').hidden = true;
        }

        contractConnect();
      }

      async function contractConnect() {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        myContract = new ethers.Contract(escrowContractAddress, escrowABI, provider);
        signer = provider.getSigner();

        var buyer = await myContract.buyerAddress();
        if (buyer === '0x0000000000000000000000000000000000000000') {
          document.getElementById('responseMessage').innerHTML = 'No funds in escrow.';
          document.getElementById('openButton').disabled = true;
          document.getElementById('closeButton').disabled = true;
          document.getElementById('sellerAddress').disabled = true;
          document.getElementById('mediatorAddress').disabled = true;
        }
      }

      async function approveButton() {
        let getAmt = document.getElementById('amount').value;
        document.getElementById('amount').disabled = true;
        document.getElementById('responseMessage').innerHTML = '<b>Approval in progress...</b>';
        document.getElementById('responseMessage').classList.remove('text-green-400');
        document.getElementById('responseMessage').classList.add('text-yellow-400');

        let approveAmt = BigInt(getAmt * 10 ** 18);
        let tokenContract = new ethers.Contract(escrowTokenAddress, escrowTokenABI, signer);

        try {
          const tx = await tokenContract.approve(escrowContractAddress, approveAmt);
          const receipt = await tx.wait();
          document.getElementById('responseMessage').innerHTML = 'Funds transfer approved.';
          document.getElementById('responseMessage').classList.remove('text-yellow-400');
          document.getElementById('responseMessage').classList.add('text-green-400');
          document.getElementById('sellerAddress').disabled = false;
          document.getElementById('mediatorAddress').disabled = false;
          document.getElementById('openButton').disabled = false;
          document.getElementById('approveButton').disabled = true;
        } catch (error) {
          console.error('Error approving token transfer:', error);
          document.getElementById('responseMessage').innerText = `Error: ${error.message}`;
        }
      }

      async function openEscrow() {
        document.getElementById('responseMessage').innerHTML = 'Open account request sent.';
        document.getElementById('responseMessage').classList.remove('text-green-400');
        document.getElementById('responseMessage').classList.add('text-yellow-400');

        const amount = document.getElementById('amount').value;
        const sellerAddress = document.getElementById('sellerAddress').value;
        const mediatorAddress = document.getElementById('mediatorAddress').value;

        if (amount <= 0 || !sellerAddress || !mediatorAddress) {
          alert('Please enter valid details for all fields.');
          return;
        }

        const wholeNumAmount = BigInt(amount * 10 ** 18);

        try {
          const contractWithSigner = myContract.connect(signer);
          const tx = await contractWithSigner.openEscrow(wholeNumAmount, sellerAddress, mediatorAddress);
          const receipt = await tx.wait();
          document.getElementById('responseMessage').innerHTML = 'Escrow account opened.';
          document.getElementById('responseMessage').classList.remove('text-yellow-400');
          document.getElementById('responseMessage').classList.add('text-green-400');
          document.getElementById('closeButton').disabled = false;
          document.getElementById('sellerAddress').disabled = true;
          document.getElementById('mediatorAddress').disabled = true;
          document.getElementById('openButton').disabled = true;
        } catch (error) {
          console.error('Error calling openEscrow():', error);
          document.getElementById('responseMessage').innerHTML = `Error: ${error.message}`;
        }
      }

      async function closeEscrow() {
        document.getElementById('responseMessage').innerHTML = 'Close account request sent.';
        document.getElementById('responseMessage').classList.remove('text-green-400');
        document.getElementById('responseMessage').classList.add('text-yellow-400');

        const closeOption = document.getElementById('closeOption').value;
        const boolVar = closeOption === 'paySeller' ? 1 : 0;

        try {
          const contractWithSigner = myContract.connect(signer);
          const tx = await contractWithSigner.closeEscrow(boolVar);
          const receipt = await tx.wait();
          document.getElementById('responseMessage').innerHTML = 'Escrow account closed.';
          document.getElementById('responseMessage').classList.remove('text-yellow-400');
          document.getElementById('responseMessage').classList.add('text-green-400');
        } catch (error) {
          console.error('Error calling closeEscrow():', error);
          document.getElementById('responseMessage').innerHTML = `Error: ${error.message}`;
        }
      }
    </script>
  </body>
</html>
